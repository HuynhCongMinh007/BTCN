<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="AppPaint.Views.DrawingCanvasPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:AppPaint.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Toolbar  -->
        <Border
            Grid.Row="0"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  Top Row: Main Groups  -->
                <Grid Grid.Row="0" Padding="12,8,12,4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  Left: Toggle Toolbar Button  -->
                    <Button
                        x:Name="ToggleToolbarButton"
                        Click="ToggleToolbarButton_Click"
                        Style="{StaticResource IconButtonStyle}"
                        ToolTipService.ToolTip="Show/Hide Toolbar">
                        <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE700;" />
                    </Button>

                    <!--  Center: Group Labels  -->
                    <StackPanel
                        Grid.Column="1"
                        Margin="16,0,0,0"
                        HorizontalAlignment="Left"
                        Orientation="Horizontal"
                        Spacing="24">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontWeight="SemiBold"
                            Text="Tools" />
                        <TextBlock
                            VerticalAlignment="Center"
                            FontWeight="SemiBold"
                            Text="Brushes" />
                        <TextBlock
                            VerticalAlignment="Center"
                            FontWeight="SemiBold"
                            Text="Canvas" />
                    </StackPanel>

                    <!--  Right: Actions  -->
                    <StackPanel
                        Grid.Column="2"
                        Orientation="Horizontal"
                        Spacing="8">
                        <Button
                            x:Name="ClearButton"
                            Command="{x:Bind ViewModel.ClearCanvasCommand}"
                            Style="{StaticResource IconButtonStyle}"
                            ToolTipService.ToolTip="Clear Canvas">
                            <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE894;" />
                        </Button>

                        <Button
                            x:Name="SaveButton"
                            Click="SaveButton_Click"
                            Style="{StaticResource AppAccentButtonStyle}"
                            ToolTipService.ToolTip="Save as Drawing">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE74E;" />
                                <TextBlock Text="Save" />
                            </StackPanel>
                        </Button>

                        <!--  Save as Template Button (visible only when shape is selected)  -->
                        <Button
                            x:Name="SaveAsTemplateButton"
                            Click="SaveAsTemplateButton_Click"
                            ToolTipService.ToolTip="Save selected shape as reusable template">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE8B7;" />
                                <TextBlock Text="Save as Template" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>

                <!--  Bottom Row: Collapsible Toolbar Content  -->
                <Grid
                    x:Name="ToolbarContent"
                    Grid.Row="1"
                    Padding="12,4,12,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!--  Group 1: Tools (Shapes)  -->
                    <Border
                        Grid.Column="0"
                        Margin="0,0,8,0"
                        Padding="12"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="4">
                        <StackPanel Spacing="8">
                            <TextBlock
                                FontSize="12"
                                Opacity="0.7"
                                Text="Shapes" />
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <!--  Select/Edit Button  -->
                                <ToggleButton
                                    x:Name="SelectButton"
                                    Width="36"
                                    Height="36"
                                    Click="SelectButton_Click"
                                    Tag="Select"
                                    ToolTipService.ToolTip="Select">
                                    <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE71C;" />
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="LineButton"
                                    Width="36"
                                    Height="36"
                                    Click="ShapeButton_Click"
                                    Tag="Line"
                                    ToolTipService.ToolTip="Line">
                                    <Viewbox Width="18" Height="18">
                                        <Canvas Width="24" Height="24">
                                            <Line
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2"
                                                X1="4"
                                                X2="20"
                                                Y1="20"
                                                Y2="4" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="RectangleButton"
                                    Width="36"
                                    Height="36"
                                    Click="ShapeButton_Click"
                                    Tag="Rectangle"
                                    ToolTipService.ToolTip="Rectangle">
                                    <Viewbox Width="18" Height="18">
                                        <Canvas Width="24" Height="24">
                                            <Rectangle
                                                Canvas.Left="4"
                                                Canvas.Top="6"
                                                Width="16"
                                                Height="12"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="OvalButton"
                                    Width="36"
                                    Height="36"
                                    Click="ShapeButton_Click"
                                    Tag="Oval"
                                    ToolTipService.ToolTip="Oval">
                                    <Viewbox Width="18" Height="18">
                                        <Canvas Width="24" Height="24">
                                            <Ellipse
                                                Canvas.Left="4"
                                                Canvas.Top="7"
                                                Width="16"
                                                Height="10"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="CircleButton"
                                    Width="36"
                                    Height="36"
                                    Click="ShapeButton_Click"
                                    Tag="Circle"
                                    ToolTipService.ToolTip="Circle">
                                    <Viewbox Width="18" Height="18">
                                        <Canvas Width="24" Height="24">
                                            <Ellipse
                                                Canvas.Left="5"
                                                Canvas.Top="5"
                                                Width="14"
                                                Height="14"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="TriangleButton"
                                    Width="36"
                                    Height="36"
                                    Click="ShapeButton_Click"
                                    Tag="Triangle"
                                    ToolTipService.ToolTip="Triangle">
                                    <Viewbox Width="18" Height="18">
                                        <Canvas Width="24" Height="24">
                                            <Polygon
                                                Points="12,4 4,20 20,20"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="PolygonButton"
                                    Width="36"
                                    Height="36"
                                    Click="ShapeButton_Click"
                                    Tag="Polygon"
                                    ToolTipService.ToolTip="Polygon">
                                    <Viewbox Width="18" Height="18">
                                        <Canvas Width="24" Height="24">
                                            <Polygon
                                                Points="12,3 20,8 18,18 6,18 4,8"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Group 2: Brushes (Color, Thickness, Style)  -->
                    <Border
                        Grid.Column="1"
                        Margin="0,0,8,0"
                        Padding="12"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="4">
                        <StackPanel Spacing="8">
                            <TextBlock
                                FontSize="12"
                                Opacity="0.7"
                                Text="Brushes" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!--  Color  -->
                                <StackPanel
                                    Grid.Column="0"
                                    Margin="0,0,12,0"
                                    Spacing="4">
                                    <TextBlock
                                        FontSize="11"
                                        Opacity="0.6"
                                        Text="Color" />

                                    <!--  Stroke Color Button with Flyout  -->
                                    <Button
                                        x:Name="StrokeColorButton"
                                        Width="36"
                                        Height="36"
                                        ToolTipService.ToolTip="Stroke Color (Nét vẽ)">
                                        <Button.Content>
                                            <Border
                                                Width="24"
                                                Height="24"
                                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                BorderThickness="1"
                                                CornerRadius="2">
                                                <Border.Background>
                                                    <SolidColorBrush x:Name="StrokeColorPreview" Color="Black" />
                                                </Border.Background>
                                            </Border>
                                        </Button.Content>
                                        <Button.Flyout>
                                            <Flyout Placement="Bottom">
                                                <StackPanel Padding="8" Spacing="12">
                                                    <TextBlock FontWeight="SemiBold" Text="Stroke Color (Màu nét vẽ)" />
                                                    <ColorPicker
                                                        x:Name="StrokeColorPicker"
                                                        ColorChanged="StrokeColorPicker_ColorChanged"
                                                        ColorSpectrumShape="Ring"
                                                        IsAlphaEnabled="False"
                                                        IsColorChannelTextInputVisible="False"
                                                        IsColorSliderVisible="True"
                                                        IsHexInputVisible="False"
                                                        Color="Black" />
                                                </StackPanel>
                                            </Flyout>
                                        </Button.Flyout>
                                    </Button>
                                </StackPanel>

                                <!--  Thickness  -->
                                <StackPanel
                                    Grid.Column="1"
                                    Margin="0,0,12,0"
                                    Spacing="4">
                                    <TextBlock
                                        FontSize="11"
                                        Opacity="0.6"
                                        Text="Size" />
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <Slider
                                            x:Name="StrokeThicknessSlider"
                                            Width="100"
                                            VerticalAlignment="Center"
                                            Maximum="20"
                                            Minimum="1"
                                            Value="{x:Bind ViewModel.StrokeThickness, Mode=TwoWay}" />
                                        <TextBlock
                                            Width="24"
                                            VerticalAlignment="Center"
                                            Text="{x:Bind StrokeThicknessSlider.Value, Mode=OneWay}" />
                                    </StackPanel>
                                </StackPanel>

                                <!--  Style & Fill  -->
                                <StackPanel Grid.Column="2" Spacing="4">
                                    <TextBlock
                                        FontSize="11"
                                        Opacity="0.6"
                                        Text="Options" />
                                    <StackPanel Spacing="4">
                                        <ComboBox
                                            x:Name="StrokeStyleComboBox"
                                            MinWidth="100"
                                            SelectedIndex="0"
                                            SelectionChanged="StrokeStyleComboBox_SelectionChanged">
                                            <ComboBoxItem Content="Solid" Tag="Solid" />
                                            <ComboBoxItem Content="Dash" Tag="Dash" />
                                            <ComboBoxItem Content="Dot" Tag="Dot" />
                                            <ComboBoxItem Content="Dash-Dot" Tag="DashDot" />
                                        </ComboBox>

                                        <!--  Fill Option with Color Picker Button  -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <CheckBox
                                                x:Name="FillCheckBox"
                                                Grid.Column="0"
                                                VerticalAlignment="Center"
                                                Content="Fill"
                                                FontSize="11"
                                                IsChecked="{x:Bind ViewModel.IsFilled, Mode=TwoWay}" />

                                            <!--  Fill Color Button (visible when Fill is checked)  -->
                                            <Button
                                                x:Name="FillColorButton"
                                                Grid.Column="1"
                                                Width="24"
                                                Height="24"
                                                Margin="4,0,0,0"
                                                ToolTipService.ToolTip="Fill Color"
                                                Visibility="{x:Bind FillCheckBox.IsChecked, Mode=OneWay}">
                                                <Button.Content>
                                                    <Border
                                                        Width="18"
                                                        Height="18"
                                                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="2">
                                                        <Border.Background>
                                                            <SolidColorBrush x:Name="FillColorPreview" Color="#FFFF00" />
                                                        </Border.Background>
                                                    </Border>
                                                </Button.Content>
                                                <Button.Flyout>
                                                    <Flyout Placement="Bottom">
                                                        <StackPanel Padding="8" Spacing="12">
                                                            <TextBlock FontWeight="SemiBold" Text="Fill Color (Màu tô)" />
                                                            <ColorPicker
                                                                x:Name="FillColorPicker"
                                                                ColorChanged="FillColorPicker_ColorChanged"
                                                                ColorSpectrumShape="Ring"
                                                                IsAlphaEnabled="False"
                                                                IsColorChannelTextInputVisible="False"
                                                                IsColorSliderVisible="True"
                                                                IsHexInputVisible="False"
                                                                Color="#FFFF00" />
                                                        </StackPanel>
                                                    </Flyout>
                                                </Button.Flyout>
                                            </Button>
                                        </Grid>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!--  Group 3: Canvas Info (READ-ONLY from Profile)  -->
                    <Border
                        Grid.Column="2"
                        Margin="0,0,8,0"
                        Padding="12"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="4">
                        <StackPanel Spacing="8">
                            <TextBlock
                                FontSize="12"
                                Opacity="0.7"
                                Text="Canvas Info" />
                            <StackPanel Spacing="4">
                                <!--  Size (READ-ONLY - from Profile)  -->
                                <TextBlock
                                    FontSize="11"
                                    Opacity="0.6"
                                    Text="Size (from Profile)" />
                                <TextBlock FontSize="13" FontWeight="SemiBold">
                                    <Run Text="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}" />
                                    <Run Text="×" />
                                    <Run Text="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}" />
                                    <Run Text="px" />
                                </TextBlock>

                                <!--  Background (READ-ONLY - from Profile)  -->
                                <TextBlock
                                    Margin="0,8,0,0"
                                    FontSize="11"
                                    Opacity="0.6"
                                    Text="Background (from Profile)" />
                                <Border
                                    Width="36"
                                    Height="36"
                                    HorizontalAlignment="Left"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4">
                                    <Border.Background>
                                        <SolidColorBrush x:Name="BackgroundColorPreview" Color="White" />
                                    </Border.Background>
                                </Border>
                                <TextBlock
                                    MaxWidth="120"
                                    FontSize="10"
                                    Opacity="0.5"
                                    Text="⚠️ Edit in Profile settings"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Polygon Finish Button (when needed)-->
                    <StackPanel
                        Grid.Column="3"
                        Margin="12,0,0,0"
                        VerticalAlignment="Center">
                        <Button
                            x:Name="FinishPolygonButton"
                            Click="FinishPolygonButton_Click"
                            Style="{StaticResource AppAccentButtonStyle}"
                            Visibility="Collapsed">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE73E;" />
                                <TextBlock Text="Finish Polygon" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>

        <!--  Canvas Area  -->
        <ScrollViewer
            Grid.Row="1"
            Padding="24"
            HorizontalScrollBarVisibility="Auto"
            VerticalScrollBarVisibility="Auto">
            <Border
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Style="{StaticResource AppCardStyle}">
                <Grid>
                    <!--  Canvas Background with Fixed Size  -->
                    <Border
                        x:Name="CanvasBackground"
                        Width="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}"
                        Height="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="4">
                        <Border.Background>
                            <SolidColorBrush x:Name="CanvasBackgroundBrush" Color="White" />
                        </Border.Background>

                        <!--  Drawing Canvas - Fixed Size  -->
                        <Canvas
                            x:Name="DrawingCanvas"
                            Width="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}"
                            Height="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}"
                            Background="Transparent" />
                    </Border>

                    <!--  Empty State  -->
                    <StackPanel
                        x:Name="EmptyState"
                        Style="{StaticResource EmptyStateStyle}"
                        Visibility="Collapsed">
                        <FontIcon
                            FontFamily="{StaticResource FluentIconsFontFamily}"
                            FontSize="64"
                            Glyph="&#xE70F;"
                            Opacity="0.3" />
                        <TextBlock
                            Opacity="0.6"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Select a tool and start drawing" />
                        <TextBlock Opacity="0.5" Text="Choose a shape from the toolbar above" />
                    </StackPanel>
                </Grid>
            </Border>
        </ScrollViewer>
    </Grid>
</Page>
