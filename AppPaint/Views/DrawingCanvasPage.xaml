<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="AppPaint.Views.DrawingCanvasPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:AppPaint.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:Data.Models"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Toolbar  -->
        <Border
            Grid.Row="0"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1">
            <Border.Shadow>
                <ThemeShadow />
            </Border.Shadow>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  Top Row: Main Groups  -->
                <Grid Grid.Row="0" Padding="16,12,16,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  Left: Toggle Toolbar Button  -->
                    <Button
                        x:Name="ToggleToolbarButton"
                        Click="ToggleToolbarButton_Click"
                        Style="{StaticResource IconButtonStyle}"
                        ToolTipService.ToolTip="Show/Hide Toolbar">
                        <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE700;" />
                    </Button>

                    <!--  Center: Group Labels  -->
                    <StackPanel
                        Grid.Column="1"
                        Margin="20,0,0,0"
                        HorizontalAlignment="Left"
                        Orientation="Horizontal"
                        Spacing="32">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="13"
                            FontWeight="SemiBold"
                            Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                            Text="🎨 Tools" />
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="13"
                            FontWeight="SemiBold"
                            Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                            Text="✏️ Brushes" />
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="13"
                            FontWeight="SemiBold"
                            Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                            Text="🖼️ Canvas" />
                    </StackPanel>

                    <!--  Right: Actions  -->
                    <StackPanel
                        Grid.Column="2"
                        Orientation="Horizontal"
                        Spacing="12">
                        <Button
                            x:Name="ClearButton"
                            Command="{x:Bind ViewModel.ClearCanvasCommand}"
                            Style="{StaticResource IconButtonStyle}"
                            ToolTipService.ToolTip="Clear Canvas">
                            <FontIcon
                                FontFamily="{StaticResource FluentIconsFontFamily}"
                                Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                Glyph="&#xE894;" />
                        </Button>

                        <Button
                            x:Name="SaveButton"
                            Click="SaveButton_Click"
                            Style="{StaticResource AppAccentButtonStyle}"
                            ToolTipService.ToolTip="Save as Drawing">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE74E;" />
                                <TextBlock FontWeight="SemiBold" Text="Save" />
                            </StackPanel>
                        </Button>

                        <!--  Save as Template Button  -->
                        <Button
                            x:Name="SaveAsTemplateButton"
                            Background="{ThemeResource AccentFillColorSecondaryBrush}"
                            Click="SaveAsTemplateButton_Click"
                            ToolTipService.ToolTip="Save selected shape as reusable template">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE8B7;" />
                                <TextBlock FontWeight="SemiBold" Text="Save as Template" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>

                <!--  Bottom Row: Collapsible Toolbar Content  -->
                <Grid
                    x:Name="ToolbarContent"
                    Grid.Row="1"
                    Padding="16,8,16,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!--  Group 1: Tools (Shapes)  -->
                    <Border
                        Grid.Column="0"
                        Margin="0,0,12,0"
                        Padding="16"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8">
                        <Border.Shadow>
                            <ThemeShadow />
                        </Border.Shadow>
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="11"
                                FontWeight="SemiBold"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Text="SHAPE TOOLS" />
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <!--  Select/Edit Button  -->
                                <ToggleButton
                                    x:Name="SelectButton"
                                    Width="40"
                                    Height="40"
                                    Click="SelectButton_Click"
                                    CornerRadius="6"
                                    Tag="Select"
                                    ToolTipService.ToolTip="Select">
                                    <FontIcon
                                        FontFamily="{StaticResource FluentIconsFontFamily}"
                                        FontSize="18"
                                        Glyph="&#xE71C;" />
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="LineButton"
                                    Width="40"
                                    Height="40"
                                    Click="ShapeButton_Click"
                                    CornerRadius="6"
                                    Tag="Line"
                                    ToolTipService.ToolTip="Line">
                                    <Viewbox Width="20" Height="20">
                                        <Canvas Width="24" Height="24">
                                            <Line
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2"
                                                X1="4"
                                                X2="20"
                                                Y1="20"
                                                Y2="4" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="RectangleButton"
                                    Width="40"
                                    Height="40"
                                    Click="ShapeButton_Click"
                                    CornerRadius="6"
                                    Tag="Rectangle"
                                    ToolTipService.ToolTip="Rectangle">
                                    <Viewbox Width="20" Height="20">
                                        <Canvas Width="24" Height="24">
                                            <Rectangle
                                                Canvas.Left="4"
                                                Canvas.Top="6"
                                                Width="16"
                                                Height="12"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="OvalButton"
                                    Width="40"
                                    Height="40"
                                    Click="ShapeButton_Click"
                                    CornerRadius="6"
                                    Tag="Oval"
                                    ToolTipService.ToolTip="Oval">
                                    <Viewbox Width="20" Height="20">
                                        <Canvas Width="24" Height="24">
                                            <Ellipse
                                                Canvas.Left="4"
                                                Canvas.Top="7"
                                                Width="16"
                                                Height="10"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="CircleButton"
                                    Width="40"
                                    Height="40"
                                    Click="ShapeButton_Click"
                                    CornerRadius="6"
                                    Tag="Circle"
                                    ToolTipService.ToolTip="Circle">
                                    <Viewbox Width="20" Height="20">
                                        <Canvas Width="24" Height="24">
                                            <Ellipse
                                                Canvas.Left="5"
                                                Canvas.Top="5"
                                                Width="14"
                                                Height="14"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="TriangleButton"
                                    Width="40"
                                    Height="40"
                                    Click="ShapeButton_Click"
                                    CornerRadius="6"
                                    Tag="Triangle"
                                    ToolTipService.ToolTip="Triangle">
                                    <Viewbox Width="20" Height="20">
                                        <Canvas Width="24" Height="24">
                                            <Polygon
                                                Points="12,4 4,20 20,20"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>

                                <ToggleButton
                                    x:Name="PolygonButton"
                                    Width="40"
                                    Height="40"
                                    Click="ShapeButton_Click"
                                    CornerRadius="6"
                                    Tag="Polygon"
                                    ToolTipService.ToolTip="Polygon">
                                    <Viewbox Width="20" Height="20">
                                        <Canvas Width="24" Height="24">
                                            <Polygon
                                                Points="12,3 20,8 18,18 6,18 4,8"
                                                Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                                StrokeThickness="2" />
                                        </Canvas>
                                    </Viewbox>
                                </ToggleButton>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Group 2: Brushes (Color, Thickness, Style)  -->
                    <Border
                        Grid.Column="1"
                        Margin="0,0,12,0"
                        Padding="16"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8">
                        <Border.Shadow>
                            <ThemeShadow />
                        </Border.Shadow>
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="11"
                                FontWeight="SemiBold"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Text="BRUSH SETTINGS" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!--  Color  -->
                                <StackPanel
                                    Grid.Column="0"
                                    Margin="0,0,16,0"
                                    Spacing="6">
                                    <TextBlock
                                        FontSize="10"
                                        FontWeight="Medium"
                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                        Text="STROKE COLOR" />

                                    <!--  Stroke Color Button with Flyout  -->
                                    <Button
                                        x:Name="StrokeColorButton"
                                        Width="44"
                                        Height="44"
                                        Padding="0"
                                        CornerRadius="8"
                                        ToolTipService.ToolTip="Stroke Color">
                                        <Button.Content>
                                            <Border
                                                Width="36"
                                                Height="36"
                                                BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                                                BorderThickness="2"
                                                CornerRadius="6">
                                                <Border.Background>
                                                    <SolidColorBrush x:Name="StrokeColorPreview" Color="#2D2D2D" />
                                                </Border.Background>
                                            </Border>
                                        </Button.Content>
                                        <Button.Flyout>
                                            <Flyout Placement="Bottom">
                                                <StackPanel Padding="16" Spacing="16">
                                                    <TextBlock
                                                        FontSize="14"
                                                        FontWeight="SemiBold"
                                                        Text="Stroke Color" />
                                                    <ColorPicker
                                                        x:Name="StrokeColorPicker"
                                                        ColorChanged="StrokeColorPicker_ColorChanged"
                                                        ColorSpectrumShape="Ring"
                                                        IsAlphaEnabled="False"
                                                        IsColorChannelTextInputVisible="True"
                                                        IsColorSliderVisible="True"
                                                        IsHexInputVisible="True"
                                                        Color="#2D2D2D" />
                                                </StackPanel>
                                            </Flyout>
                                        </Button.Flyout>
                                    </Button>
                                </StackPanel>

                                <!--  Thickness  -->
                                <StackPanel
                                    Grid.Column="1"
                                    Margin="0,0,16,0"
                                    Spacing="6">
                                    <TextBlock
                                        FontSize="10"
                                        FontWeight="Medium"
                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                        Text="THICKNESS" />
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <Slider
                                            x:Name="StrokeThicknessSlider"
                                            Width="120"
                                            VerticalAlignment="Center"
                                            Maximum="20"
                                            Minimum="1"
                                            Value="{x:Bind ViewModel.StrokeThickness, Mode=TwoWay}" />
                                        <Border
                                            MinWidth="32"
                                            Padding="8,4"
                                            Background="{ThemeResource AccentFillColorSecondaryBrush}"
                                            CornerRadius="4">
                                            <TextBlock
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                FontWeight="SemiBold"
                                                Text="{x:Bind StrokeThicknessSlider.Value, Mode=OneWay}" />
                                        </Border>
                                    </StackPanel>
                                </StackPanel>

                                <!--  Style & Fill  -->
                                <StackPanel Grid.Column="2" Spacing="6">
                                    <TextBlock
                                        FontSize="10"
                                        FontWeight="Medium"
                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                        Text="STYLE &amp; FILL" />
                                    <StackPanel Spacing="8">
                                        <ComboBox
                                            x:Name="StrokeStyleComboBox"
                                            MinWidth="130"
                                            CornerRadius="6"
                                            SelectedIndex="0"
                                            SelectionChanged="StrokeStyleComboBox_SelectionChanged">
                                            <ComboBoxItem Content="━ Solid" Tag="Solid" />
                                            <ComboBoxItem Content="╌ Dash" Tag="Dash" />
                                            <ComboBoxItem Content="··· Dot" Tag="Dot" />
                                            <ComboBoxItem Content="━·━ Dash-Dot" Tag="DashDot" />
                                        </ComboBox>

                                        <!--  Fill Option with Color Picker Button  -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <CheckBox
                                                x:Name="FillCheckBox"
                                                Grid.Column="0"
                                                VerticalAlignment="Center"
                                                Content="Fill"
                                                FontSize="12"
                                                FontWeight="Medium"
                                                IsChecked="{x:Bind ViewModel.IsFilled, Mode=TwoWay}" />

                                            <!--  Fill Color Button  -->
                                            <Button
                                                x:Name="FillColorButton"
                                                Grid.Column="1"
                                                Width="32"
                                                Height="32"
                                                Margin="8,0,0,0"
                                                Padding="0"
                                                HorizontalAlignment="Right"
                                                CornerRadius="6"
                                                ToolTipService.ToolTip="Fill Color"
                                                Visibility="{x:Bind FillCheckBox.IsChecked, Mode=OneWay}">
                                                <Button.Content>
                                                    <Border
                                                        Width="24"
                                                        Height="24"
                                                        BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                                                        BorderThickness="2"
                                                        CornerRadius="4">
                                                        <Border.Background>
                                                            <SolidColorBrush x:Name="FillColorPreview" Color="#FFB900" />
                                                        </Border.Background>
                                                    </Border>
                                                </Button.Content>
                                                <Button.Flyout>
                                                    <Flyout Placement="Bottom">
                                                        <StackPanel Padding="16" Spacing="16">
                                                            <TextBlock
                                                                FontSize="14"
                                                                FontWeight="SemiBold"
                                                                Text="Fill Color" />
                                                            <ColorPicker
                                                                x:Name="FillColorPicker"
                                                                ColorChanged="FillColorPicker_ColorChanged"
                                                                ColorSpectrumShape="Ring"
                                                                IsAlphaEnabled="False"
                                                                IsColorChannelTextInputVisible="True"
                                                                IsColorSliderVisible="True"
                                                                IsHexInputVisible="True"
                                                                Color="#FFB900" />
                                                        </StackPanel>
                                                    </Flyout>
                                                </Button.Flyout>
                                            </Button>
                                        </Grid>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!--  Group 3: Canvas Info (READ-ONLY from Profile)  -->
                    <Border
                        Grid.Column="2"
                        Margin="0,0,12,0"
                        Padding="16"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8">
                        <Border.Shadow>
                            <ThemeShadow />
                        </Border.Shadow>
                        <StackPanel Spacing="12">
                            <TextBlock
                                FontSize="11"
                                FontWeight="SemiBold"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Text="CANVAS INFO" />
                            <StackPanel Spacing="8">
                                <!--  Size  -->
                                <TextBlock
                                    FontSize="10"
                                    FontWeight="Medium"
                                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                    Text="SIZE (FROM PROFILE)" />
                                <Border
                                    Padding="12,8"
                                    Background="{ThemeResource AccentFillColorTertiaryBrush}"
                                    CornerRadius="6">
                                    <TextBlock
                                        FontSize="14"
                                        FontWeight="SemiBold"
                                        Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}">
                                        <Run Text="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}" />
                                        <Run Text="×" />
                                        <Run Text="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}" />
                                        <Run FontSize="11" Text="px" />
                                    </TextBlock>
                                </Border>

                                <!--  Background  -->
                                <TextBlock
                                    Margin="0,8,0,0"
                                    FontSize="10"
                                    FontWeight="Medium"
                                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                    Text="BACKGROUND" />
                                <Border
                                    Width="44"
                                    Height="44"
                                    HorizontalAlignment="Left"
                                    BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                                    BorderThickness="2"
                                    CornerRadius="8">
                                    <Border.Background>
                                        <SolidColorBrush x:Name="BackgroundColorPreview" Color="White" />
                                    </Border.Background>
                                </Border>
                                <TextBlock
                                    MaxWidth="140"
                                    FontSize="9"
                                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                    Text="⚙️ Edit in Profile settings"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Polygon Finish Button  -->
                    <StackPanel
                        Grid.Column="3"
                        Margin="16,0,0,0"
                        VerticalAlignment="Center">
                        <Button
                            x:Name="FinishPolygonButton"
                            Click="FinishPolygonButton_Click"
                            CornerRadius="6"
                            Style="{StaticResource AppAccentButtonStyle}"
                            Visibility="Collapsed">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <FontIcon FontFamily="{StaticResource FluentIconsFontFamily}" Glyph="&#xE73E;" />
                                <TextBlock FontWeight="SemiBold" Text="Finish Polygon" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>

        <!--  Canvas Area  -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!--  Main Canvas Area  -->
            <ScrollViewer
                Grid.Column="0"
                Padding="32"
                HorizontalScrollBarVisibility="Auto"
                VerticalScrollBarVisibility="Auto">
                <Border
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    CornerRadius="12">
                    <Border.Shadow>
                        <ThemeShadow />
                    </Border.Shadow>
                    <Grid>
                        <!--  Canvas Background with Fixed Size  -->
                        <Border
                            x:Name="CanvasBackground"
                            Width="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}"
                            Height="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="2"
                            CornerRadius="8">
                            <Border.Background>
                                <SolidColorBrush x:Name="CanvasBackgroundBrush" Color="White" />
                            </Border.Background>

                            <!--  Drawing Canvas  -->
                            <Canvas
                                x:Name="DrawingCanvas"
                                Width="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}"
                                Height="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}"
                                AllowDrop="True"
                                Background="Transparent"
                                DragOver="DrawingCanvas_DragOver"
                                Drop="DrawingCanvas_Drop" />
                        </Border>

                        <!--  Empty State  -->
                        <StackPanel
                            x:Name="EmptyState"
                            Style="{StaticResource EmptyStateStyle}"
                            Visibility="Collapsed">
                            <FontIcon
                                FontFamily="{StaticResource FluentIconsFontFamily}"
                                FontSize="72"
                                Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                Glyph="&#xE70F;" />
                            <TextBlock
                                FontSize="18"
                                FontWeight="SemiBold"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Text="Select a tool and start drawing" />
                            <TextBlock
                                FontSize="13"
                                Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                Text="Choose a shape from the toolbar above" />
                        </StackPanel>
                    </Grid>
                </Border>
            </ScrollViewer>

            <!--  Template Panel (Right Side)  -->
            <Border
                x:Name="TemplatePanel"
                Grid.Column="1"
                Width="340"
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1,0,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Header  -->
                    <Grid
                        Grid.Row="0"
                        Padding="20,16"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="0,0,0,1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock
                                FontSize="18"
                                FontWeight="Bold"
                                Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                Text="📦 Templates" />
                            <TextBlock
                                FontSize="11"
                                Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                Text="Drag to canvas or click to insert" />
                        </StackPanel>

                        <Button
                            x:Name="ToggleTemplatePanelButton"
                            Grid.Column="1"
                            Width="36"
                            Height="36"
                            Padding="0"
                            Click="ToggleTemplatePanel_Click"
                            CornerRadius="6"
                            ToolTipService.ToolTip="Hide Templates">
                            <FontIcon
                                FontFamily="{StaticResource FluentIconsFontFamily}"
                                FontSize="16"
                                Glyph="&#xE76C;" />
                        </Button>
                    </Grid>

                    <!--  Templates List  -->
                    <ScrollViewer Grid.Row="1" Padding="16">
                        <ItemsRepeater x:Name="TemplatesRepeater" ItemsSource="{x:Bind ViewModel.AvailableTemplates, Mode=OneWay}">
                            <ItemsRepeater.Layout>
                                <StackLayout Spacing="16" />
                            </ItemsRepeater.Layout>
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate x:DataType="models:DrawingTemplate">
                                    <Border
                                        x:Name="TemplateCard"
                                        Padding="16"
                                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CanDrag="True"
                                        CornerRadius="12"
                                        DragStarting="Template_DragStarting"
                                        PointerEntered="TemplateCard_PointerEntered"
                                        PointerExited="TemplateCard_PointerExited">
                                        <Border.Shadow>
                                            <ThemeShadow />
                                        </Border.Shadow>
                                        <Border.RenderTransform>
                                            <ScaleTransform x:Name="CardScale" CenterX="154" CenterY="100" ScaleX="1" ScaleY="1" />
                                        </Border.RenderTransform>
                                        <Border.Transitions>
                                            <TransitionCollection>
                                                <RepositionThemeTransition />
                                            </TransitionCollection>
                                        </Border.Transitions>

                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="150" />
                                            </Grid.RowDefinitions>

                                            <!--  Name  -->
                                            <TextBlock
                                                Grid.Row="0"
                                                Margin="0,0,0,12"
                                                FontSize="15"
                                                FontWeight="SemiBold"
                                                Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                Text="{x:Bind Name}"
                                                TextTrimming="CharacterEllipsis" />

                                            <!--  Clickable Preview with Hover Effect  -->
                                            <Button
                                                Grid.Row="1"
                                                Padding="0"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                Click="TemplatePreview_Click"
                                                CornerRadius="8"
                                                Tag="{x:Bind}">
                                                <Button.Resources>
                                                    <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="Transparent" />
                                                    <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="Transparent" />
                                                </Button.Resources>
                                                <Border
                                                    x:Name="PreviewBorder"
                                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                    BorderThickness="2"
                                                    CornerRadius="8">
                                                    <Border.Background>
                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                            <GradientStop Offset="0" Color="{ThemeResource SystemFillColorNeutralBackgroundBrush}" />
                                                            <GradientStop Offset="1" Color="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}" />
                                                        </LinearGradientBrush>
                                                    </Border.Background>
                                                    <Border.Transitions>
                                                        <TransitionCollection>
                                                            <AddDeleteThemeTransition />
                                                        </TransitionCollection>
                                                    </Border.Transitions>

                                                    <Grid>
                                                        <Viewbox
                                                            Margin="16"
                                                            Stretch="Uniform"
                                                            StretchDirection="DownOnly">
                                                            <Canvas
                                                                x:Name="TemplatePreviewCanvas"
                                                                Width="800"
                                                                Height="600"
                                                                Loaded="TemplatePreviewCanvas_Loaded"
                                                                Tag="{x:Bind}" />
                                                        </Viewbox>

                                                        <!--  Hover Overlay  -->
                                                        <Border
                                                            x:Name="HoverOverlay"
                                                            CornerRadius="8"
                                                            Opacity="0">
                                                            <Border.Background>
                                                                <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                                                                    <GradientStop Offset="0" Color="#60000000" />
                                                                    <GradientStop Offset="1" Color="#80000000" />
                                                                </LinearGradientBrush>
                                                            </Border.Background>
                                                            <Border.Transitions>
                                                                <TransitionCollection>
                                                                    <AddDeleteThemeTransition />
                                                                </TransitionCollection>
                                                            </Border.Transitions>

                                                            <StackPanel
                                                                HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"
                                                                Spacing="16">
                                                                <Border
                                                                    Width="64"
                                                                    Height="64"
                                                                    Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                                    CornerRadius="32">
                                                                    <FontIcon
                                                                        FontFamily="{StaticResource FluentIconsFontFamily}"
                                                                        FontSize="32"
                                                                        Foreground="White"
                                                                        Glyph="&#xE710;">
                                                                        <FontIcon.Shadow>
                                                                            <ThemeShadow />
                                                                        </FontIcon.Shadow>
                                                                    </FontIcon>
                                                                </Border>
                                                                <TextBlock
                                                                    FontSize="16"
                                                                    FontWeight="Bold"
                                                                    Foreground="White"
                                                                    Text="Click to Insert">
                                                                    <TextBlock.Shadow>
                                                                        <ThemeShadow />
                                                                    </TextBlock.Shadow>
                                                                </TextBlock>
                                                            </StackPanel>
                                                        </Border>
                                                    </Grid>

                                                    <VisualStateManager.VisualStateGroups>
                                                        <VisualStateGroup x:Name="CommonStates">
                                                            <VisualState x:Name="Normal">
                                                                <Storyboard>
                                                                    <DoubleAnimation
                                                                        Storyboard.TargetName="HoverOverlay"
                                                                        Storyboard.TargetProperty="Opacity"
                                                                        To="0"
                                                                        Duration="0:0:0.3">
                                                                        <DoubleAnimation.EasingFunction>
                                                                            <CubicEase EasingMode="EaseOut" />
                                                                        </DoubleAnimation.EasingFunction>
                                                                    </DoubleAnimation>
                                                                </Storyboard>
                                                            </VisualState>
                                                            <VisualState x:Name="PointerOver">
                                                                <Storyboard>
                                                                    <DoubleAnimation
                                                                        Storyboard.TargetName="HoverOverlay"
                                                                        Storyboard.TargetProperty="Opacity"
                                                                        To="1"
                                                                        Duration="0:0:0.25">
                                                                        <DoubleAnimation.EasingFunction>
                                                                            <CubicEase EasingMode="EaseOut" />
                                                                        </DoubleAnimation.EasingFunction>
                                                                    </DoubleAnimation>
                                                                </Storyboard>
                                                                <VisualState.Setters>
                                                                    <Setter Target="PreviewBorder.BorderBrush" Value="{ThemeResource AccentFillColorDefaultBrush}" />
                                                                    <Setter Target="PreviewBorder.BorderThickness" Value="3" />
                                                                </VisualState.Setters>
                                                            </VisualState>
                                                            <VisualState x:Name="Pressed">
                                                                <Storyboard>
                                                                    <DoubleAnimation
                                                                        Storyboard.TargetName="HoverOverlay"
                                                                        Storyboard.TargetProperty="Opacity"
                                                                        To="1"
                                                                        Duration="0:0:0.15">
                                                                        <DoubleAnimation.EasingFunction>
                                                                            <CubicEase EasingMode="EaseOut" />
                                                                        </DoubleAnimation.EasingFunction>
                                                                    </DoubleAnimation>
                                                                </Storyboard>
                                                                <VisualState.Setters>
                                                                    <Setter Target="PreviewBorder.BorderBrush" Value="{ThemeResource AccentFillColorTertiaryBrush}" />
                                                                    <Setter Target="PreviewBorder.BorderThickness" Value="3" />
                                                                </VisualState.Setters>
                                                            </VisualState>
                                                        </VisualStateGroup>
                                                    </VisualStateManager.VisualStateGroups>
                                                </Border>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!--  Show Template Panel Button (when hidden)  -->
            <Button
                x:Name="ShowTemplatePanelButton"
                Grid.Column="1"
                Width="56"
                Height="140"
                Margin="0,24,0,0"
                Padding="12"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Click="ToggleTemplatePanel_Click"
                CornerRadius="8,0,0,8"
                ToolTipService.ToolTip="Show Templates"
                Visibility="Collapsed">
                <StackPanel HorizontalAlignment="Center" Spacing="12">
                    <FontIcon
                        FontFamily="{StaticResource FluentIconsFontFamily}"
                        FontSize="24"
                        Glyph="&#xE76B;" />
                    <TextBlock
                        FontSize="12"
                        FontWeight="SemiBold"
                        Text="Templates"
                        TextAlignment="Center"
                        TextWrapping="Wrap" />
                </StackPanel>
            </Button>
        </Grid>
    </Grid>
</Page>
